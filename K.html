<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Himalayan Royals</title>
    <!-- Tailwind CSS CDN for basic styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #1e293b; /* A deep, rich blue for a royal feel */
            background-image: linear-gradient(to bottom right, #1e293b, #0f172a);
        }
        
        /* Confetti canvas on top of everything */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Main app container styling */
        #main-app-container {
            background-color: #2D3E50;
            border: 2px solid #FFD700;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        /* Custom styles for the spin wheel container */
        .wheel-container {
            position: relative;
            width: 350px;
            height: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            overflow: hidden;
            background-color: #fff;
            transition: transform 4s cubic-bezier(0.2, 0.9, 0.4, 1.0); /* Spinning animation */
        }
        
        /* Custom styles for the pointer/arrow */
        .pointer {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #FFD700; /* Gold color */
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        /* Spin button animation for hover and active states */
        .spin-btn-anim:hover {
            box-shadow: 0 0 20px #FFD700;
        }
        .spin-btn-anim:active {
            transform: scale(0.95);
        }
        
        /* Winning segment animation */
        .winning-animation {
            animation: pulse-border 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0px rgba(255, 215, 0, 0); }
        }
        
        /* Styles for the hamburger menu icon */
        .hamburger-icon span {
            display: block;
            width: 30px;
            height: 3px;
            background-color: #FFD700;
            margin: 6px 0;
            transition: all 0.3s ease-in-out;
        }
        
        /* Light Bulb Styling */
        .light-bulb {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #FFD700; /* Gold color */
            box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            z-index: 1; /* Place below the canvas */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <canvas id="confetti-canvas"></canvas>

    <!-- Main App Container -->
    <div id="main-app-container" class="relative w-full max-w-sm mx-auto p-4 md:p-6 rounded-xl shadow-2xl flex-col items-center">
        <!-- Header Section -->
        <div class="w-full flex justify-between items-center mb-6">
            <!-- App Name & Balance -->
            <div class="text-center w-full">
                <h1 class="text-3xl font-bold text-yellow-500">Himalayan Royals</h1>
                <p class="text-lg font-semibold text-gray-300 mt-2">Balance: <span id="xd-balance">0</span> XD</p>
            </div>
            
            <!-- Hamburger Menu Icon -->
            <button id="menu-btn" class="absolute top-4 right-4 focus:outline-none">
                <div class="hamburger-icon space-y-2">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
        
        <!-- Spin Wheel Section -->
        <div id="spin-section" class="w-full flex flex-col items-center">
            <!-- Spin Wheel and Pointer -->
            <div class="relative flex items-center justify-center mb-8">
                <div id="wheel-container" class="wheel-container">
                    <canvas id="wheelCanvas" width="350" height="350"></canvas>
                </div>
                <div class="pointer"></div>
            </div>

            <!-- Spin Button -->
            <button id="spin-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-500 disabled:cursor-not-allowed spin-btn-anim">
                Spin the Wheel!
            </button>
        </div>

        <!-- Withdraw Section -->
        <div id="withdraw-section" class="w-full hidden text-gray-100">
            <h2 class="text-2xl font-bold text-yellow-500 text-center mb-4">Withdraw Funds</h2>
            <div class="bg-yellow-600 text-gray-900 p-4 rounded-lg mb-6 shadow-lg">
                <p class="text-sm font-semibold">NOTE: 100 XD = 1 RBX. You need to create a Gamepass of 40% higher than the amount you want to redeem because Pls Donate deducts a fee.</p>
            </div>
            <form id="withdraw-form" class="space-y-4">
                <div>
                    <label for="redeem-amount-rbx" class="block text-sm font-medium">Enter Amount to Redeem (RBX)</label>
                    <input type="number" id="redeem-amount-rbx" name="redeem-amount-rbx" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm text-white" placeholder="Minimum 7 RBX">
                </div>

                <div id="calculated-amounts" class="space-y-2 text-sm font-medium">
                    <p>Equivalent XD to be deducted: <span id="xd-deducted-amount" class="font-bold text-yellow-500">0</span> XD</p>
                    <p>Gamepass amount to create: <span id="gamepass-amount" class="font-bold text-yellow-500">0</span> RBX</p>
                </div>

                <div>
                    <label for="roblox-username" class="block text-sm font-medium">Enter Roblox Username</label>
                    <input type="text" id="roblox-username" name="roblox-username" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm text-white" placeholder="Your Roblox Username">
                </div>
                <div>
                    <label for="remarks" class="block text-sm font-medium">Remarks</label>
                    <textarea id="remarks" name="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm text-white" placeholder="Optional comments"></textarea>
                </div>
                <button type="submit" id="withdraw-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    Withdraw
                </button>
            </form>
        </div>

        <!-- Notification Section -->
        <div id="notification-section" class="w-full hidden text-gray-100">
            <h2 class="text-2xl font-bold text-yellow-500 text-center mb-4">Notifications</h2>
            <div id="notification-list-container" class="bg-gray-800 p-4 rounded-lg shadow-md max-h-64 overflow-y-auto">
                <ul id="notification-list" class="space-y-2">
                    <!-- Notifications will be dynamically added here -->
                </ul>
            </div>
            <button id="clear-notifications-btn" class="w-full mt-4 bg-gray-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">
                Clear All Notifications
            </button>
        </div>

        <!-- Policy Section -->
        <div id="policy-section" class="w-full hidden text-gray-100 p-4">
            <h2 class="text-2xl font-bold text-yellow-500 text-center mb-4">Our Policy</h2>
            <div class="bg-gray-800 p-4 rounded-lg shadow-md">
                <p class="text-base text-gray-300">
                    We are committed to providing a transparent and fair platform for earning Robux.
                    User data is handled with the utmost care and is not shared with any third parties.
                    By using this service, you agree to our terms of service and responsible usage.
                </p>
            </div>
        </div>

        <!-- User Info -->
        <div class="absolute bottom-4 left-4 text-xs text-gray-400 font-mono">
            <p>Username: <span id="user-username" class="font-bold text-white"></span></p>
            <p>Referral Code: <span id="user-referral-code" class="font-bold text-white"></span></p>
        </div>
    </div>
    
    <!-- Sidebar / Menu -->
    <div id="sidebar" class="fixed top-0 right-0 h-full w-64 bg-gray-900 shadow-xl transform translate-x-full transition-transform duration-300 z-50">
        <div class="p-6">
            <button id="close-menu-btn" class="absolute top-4 right-4 text-yellow-500 text-2xl font-bold focus:outline-none">
                &times;
            </button>
            <h2 class="text-xl font-bold text-yellow-500 mb-6">Menu</h2>
            <nav>
                <ul class="space-y-4">
                    <li><a href="#" data-section="spin" class="block text-lg text-gray-400 hover:text-yellow-500 font-semibold transition-colors duration-200">Spin Wheel</a></li>
                    <li><a href="#" data-section="withdraw" class="block text-lg text-gray-400 hover:text-yellow-500 font-semibold transition-colors duration-200">Withdraw</a></li>
                    <li><a href="#" data-section="notification" class="block text-lg text-gray-400 hover:text-yellow-500 font-semibold transition-colors duration-200">Notifications</a></li>
                    <li><a href="#" data-section="policy" class="block text-lg text-gray-400 hover:text-yellow-500 font-semibold transition-colors duration-200">Policy</a></li>
                    <li><button id="logout-btn" class="w-full text-left text-lg text-red-500 hover:text-red-600 font-semibold transition-colors duration-200">Log Out</button></li>
                </ul>
            </nav>
        </div>
    </div>

    <script type="module">
        // This file contains all the JavaScript logic for the Himalayan Royals game.
        // It should be linked from the main HTML file.
        
        // Import the required Firebase services.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Include Tone.js for sound effects.
        import "https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js";
        
        // --- Firebase Security Rules ---
        // For this app to work, you MUST set up these security rules in your Firestore console.
        // Go to Firestore > Rules and replace the existing rules with the ones below.
        // Make sure to publish them after pasting.
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /artifacts/{appId}/public/data/users/{userId} {
              allow read, write: if request.auth != null;
            }
          }
        }
        */
        
        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = '';
        
        /**
         * Signs in the user using the provided custom token or anonymously.
         * This function must be awaited before any Firestore operations.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase authentication successful. User ID:", userId);
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                console.error("Authentication Error", "Failed to authenticate with Firebase. Please try again.");
            }
        }
        
        // --- Game Configuration ---
        // Updated color scheme and chances
        const segments = [
            { text: '2 XD', value: 2, chance: 37, color: '#2C3E50' },
            { text: '4 XD', value: 4, chance: 30, color: '#34495E' },
            { text: '10 XD', value: 10, chance: 10, color: '#F39C12' },
            { text: '20 XD', value: 20, chance: 5, color: '#F1C40F' },
            { text: '16 XD', value: 16, chance: 15, color: '#3498DB' },
            { text: '50 XD', value: 50, chance: 2, color: '#E74C3C' },
            { text: '100 XD', value: 100, chance: 0.9, color: '#9B59B6' },
            { text: 'Jackpot', value: 0, chance: 0.1, color: '#FFD700' }, // Jackpot is now winnable
        ];
        
        // Jackpot constants
        const JACKPOT_INCREMENT_PER_MINUTE = 100;
        
        // Withdrawal constants
        const MIN_WITHDRAW_RBX = 7;
        const RBX_TO_XD_RATE = 100;
        const GAMEPASS_DEDUCTION_RATE = 0.40;
        const REFERRAL_BONUS_RATE = 0.10;
        
        // --- State Variables ---
        let xdBalance = 0;
        let jackpot = 0;
        let userReferralCode = '';
        let referredBy = null;
        let isSpinning = false;
        let notifications = [];
        let username = '';
        
        // --- Audio Context & Sound Effects ---
        let spinSound, winSound;
        try {
            // A synth for the spinning sound effect
            const spinSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'square' },
                envelope: {
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.1
                }
            }).toDestination();
            
            // A loop to play a sound every 8th note while spinning
            spinSound = new Tone.Loop(time => {
                spinSynth.triggerAttackRelease("C4", "8n", time);
            }, "8n");
        
            // A synth for the winning chime
            winSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 0.005,
                    decay: 0.5,
                    sustain: 0.1,
                    release: 1
                }
            }).toDestination();
        } catch (e) {
            console.error("Tone.js failed to initialize:", e);
        }
        
        // --- DOM Elements ---
        const wheelCanvas = document.getElementById('wheelCanvas');
        const ctx = wheelCanvas.getContext('2d');
        const spinBtn = document.getElementById('spin-btn');
        const xdBalanceEl = document.getElementById('xd-balance');
        const userUsernameEl = document.getElementById('user-username');
        const userReferralCodeEl = document.getElementById('user-referral-code');
        const wheelContainer = document.getElementById('wheel-container');
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const spinSection = document.getElementById('spin-section');
        const withdrawSection = document.getElementById('withdraw-section');
        const notificationSection = document.getElementById('notification-section');
        const redeemAmountRbxInput = document.getElementById('redeem-amount-rbx');
        const robloxUsernameInput = document.getElementById('roblox-username');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const xdDeductedAmountEl = document.getElementById('xd-deducted-amount');
        const gamepassAmountEl = document.getElementById('gamepass-amount');
        const notificationList = document.getElementById('notification-list');
        const clearNotificationsBtn = document.getElementById('clear-notifications-btn');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        
        // --- Confetti VFX ---
        const confettiParticles = [];
        const confettiColors = ['#FFD700', '#F1C40F', '#F39C12', '#FFFFFF', '#3498DB'];
        const confettiDuration = 3000;
        
        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * -confettiCanvas.height,
                    vx: Math.random() * 6 - 3,
                    vy: Math.random() * 3 + 2,
                    rot: Math.random() * 360,
                    color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
                    opacity: 1,
                    size: Math.random() * 8 + 4
                });
            }
        }
        
        function drawConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            for (let i = 0; i < confettiParticles.length; i++) {
                const p = confettiParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.05; // Gravity
                p.opacity -= 0.01;
                
                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.rot * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.globalAlpha = p.opacity;
                confettiCtx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                confettiCtx.restore();
        
                if (p.y > confettiCanvas.height || p.opacity <= 0) {
                    confettiParticles.splice(i, 1);
                    i--;
                }
            }
            if (confettiParticles.length > 0) {
                requestAnimationFrame(drawConfetti);
            }
        }
        
        /**
         * Triggers the confetti effect for a specified duration.
         */
        function triggerConfetti() {
            createConfetti();
            drawConfetti();
            setTimeout(() => {
                confettiParticles.length = 0;
            }, confettiDuration);
        }
        
        // --- Helper Functions ---
        
        /**
         * Creates and appends the light bulbs to the wheel container.
         * There will be one light bulb at each segment division point.
         */
        function createLightBulbs() {
            const numBulbs = segments.length;
            // Remove any existing bulbs first
            const existingBulbs = wheelContainer.querySelectorAll('.light-bulb');
            existingBulbs.forEach(bulb => bulb.remove());
        
            const radius = 175; // Half of wheel-container size
            const bulbSize = 16;
            const offset = 8; // Half of bulb size
            
            for (let i = 0; i < numBulbs; i++) {
                const bulb = document.createElement('div');
                bulb.className = 'light-bulb';
                
                // Position the bulb at the start of each segment's arc
                const angle = (i / numBulbs) * 360 - 90; // -90 to align the start to the top of the wheel
                const x = radius + radius * Math.cos(angle * Math.PI / 180);
                const y = radius + radius * Math.sin(angle * Math.PI / 180);
                
                bulb.style.top = `${y - offset}px`;
                bulb.style.left = `${x - offset}px`;
                
                wheelContainer.appendChild(bulb);
            }
        }
        
        /**
         * Fetches a user's data from Firestore.
         * @param {string} id The user's Firebase UID.
         * @returns {object} The user's data or null if not found.
         */
        async function fetchUserData(id) {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, id);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.log("No such user document!");
                    return null;
                }
            } catch (e) {
                console.error("Error fetching user data:", e);
                return null;
            }
        }
        
        /**
         * Updates a user's data in Firestore.
         * @param {string} id The user's Firebase UID.
         * @param {object} data The data to update.
         */
        async function updateUserData(id, data) {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, id);
            try {
                await updateDoc(userDocRef, data);
            } catch (e) {
                console.error("Error updating user data:", e);
            }
        }
        
        /**
         * Draws the prize wheel on the canvas.
         */
        function drawWheel() {
            const totalSegments = segments.length;
            const arcSize = (2 * Math.PI) / totalSegments;
            const radius = wheelCanvas.width / 2;
            const centerX = radius;
            const centerY = radius;
            ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
        
            const segmentsToDraw = segments.map(segment => {
                if (segment.text.startsWith('Jackpot')) {
                    return { ...segment, text: `Jackpot: ${jackpot} XD` };
                }
                return segment;
            });
        
            segmentsToDraw.forEach((segment, i) => {
                const startAngle = i * arcSize;
                const endAngle = (i + 1) * arcSize;
        
                // Draw the segment
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = segment.color;
                ctx.fill();
        
                // Draw the text
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + arcSize / 2);
                ctx.textAlign = 'right';
                ctx.fillStyle = '#E0E0E0';
                ctx.font = 'bold 16px Poppins';
                ctx.fillText(segment.text, radius * 0.85, 5);
                ctx.restore();
            });
        
            // Draw the center circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
            ctx.fillStyle = '#1e293b';
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#FFD700';
            ctx.stroke();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 12px Poppins';
            ctx.fillText('SPIN', centerX, centerY);
        }
        
        /**
         * Selects a winning segment based on probabilities.
         * @returns {object} The winning segment.
         */
        function getRandomSegment() {
            const totalChance = segments.reduce((acc, seg) => acc + seg.chance, 0);
            const rand = Math.random() * totalChance;
            let cumulativeChance = 0;
            for (const segment of segments) {
                cumulativeChance += segment.chance;
                if (rand < cumulativeChance) {
                    return segment;
                }
            }
            return segments[segments.length - 1]; 
        }
        
        /**
         * Handles the spinning animation and result.
         */
        function spin() {
            if (isSpinning) return;
            isSpinning = true;
            spinBtn.disabled = true;
            
            // Start the spin sound and activate audio context
            Tone.start();
            spinSound.start();
        
            const winningSegment = getRandomSegment();
            const segmentIndex = segments.indexOf(winningSegment);
            const totalSegments = segments.length;
            const segmentArc = 360 / totalSegments;
            
            // Calculate the angle to precisely land on the winning segment
            const targetAngleForSegment = (segmentIndex * segmentArc) + (segmentArc / 2);
            // The pointer is at 90 degrees relative to the canvas's 3 o'clock start point.
            // We need to subtract the segment's angle from 270 degrees to align it with the pointer.
            const finalAngle = (270 - targetAngleForSegment + 360) % 360;
        
            // Rotate the wheel a total of 5 full rotations plus the final calculated angle
            const totalRotation = 360 * 5 + finalAngle;
            
            let start = null;
            const duration = 4000;
            
            function animate(timestamp) {
                if (!start) start = timestamp;
                const elapsed = timestamp - start;
                const progress = Math.min(elapsed / duration, 1);
                
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const rotation = easedProgress * totalRotation;
                
                wheelContainer.style.transform = `rotate(${rotation}deg)`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Stop the spin sound and animation
                    spinSound.stop();
                    isSpinning = false;
                    spinBtn.disabled = false;
                    handleWin(winningSegment);
                }
            }
            requestAnimationFrame(animate);
        }
        
        /**
         * Handles the win, updates balance, and saves data to Firestore.
         * @param {object} winningSegment The segment the wheel landed on.
         */
        async function handleWin(winningSegment) {
            let winAmount = winningSegment.value;
            let message = '';
            
            if (winningSegment.text.startsWith('Jackpot')) {
                if (jackpot > 0) {
                    winAmount = jackpot;
                    jackpot = 0;
                    message = `Congratulations! You won the Jackpot of ${winAmount} XD!`;
                    triggerConfetti();
                    winSound.triggerAttackRelease("C5", "8n");
                } else {
                    winAmount = 0;
                    message = `Sorry, the Jackpot was empty. Better luck next time!`;
                }
            } else {
                message = `You won ${winAmount} XD!`;
                winSound.triggerAttackRelease("G4", "8n");
            }
            
            console.log('Spin Result:', message);
            xdBalance += winAmount;
            
            notifications.unshift({
                message: message,
                timestamp: new Date().toISOString()
            });
            await updateUserData(userId, { xdBalance: xdBalance, notifications: notifications, jackpot: jackpot });
            
            updateUI();
        }
        
        /**
         * Updates the UI to reflect the current state.
         */
        function updateUI() {
            xdBalanceEl.textContent = xdBalance.toLocaleString();
            userUsernameEl.textContent = username;
            userReferralCodeEl.textContent = userReferralCode;
            drawWheel();
        
            notificationList.innerHTML = '';
            notifications.forEach(note => {
                const li = document.createElement('li');
                li.className = 'text-gray-300 p-2 border-b border-gray-700 last:border-b-0 text-sm';
                const date = new Date(note.timestamp).toLocaleString();
                li.innerHTML = `<span class="font-semibold text-yellow-500">${note.message}</span> <br> <span class="text-xs text-gray-500">${date}</span>`;
                notificationList.appendChild(li);
            });
        
            clearNotificationsBtn.disabled = notifications.length === 0;
            if (notifications.length > 0) {
                clearNotificationsBtn.classList.remove('disabled:bg-gray-500', 'disabled:cursor-not-allowed');
                clearNotificationsBtn.classList.add('hover:bg-red-600');
            } else {
                clearNotificationsBtn.classList.remove('hover:bg-red-600');
                clearNotificationsBtn.classList.add('disabled:bg-gray-500', 'disabled:cursor-not-allowed');
            }
        }
        
        /**
         * Dynamically updates the calculated withdrawal amounts.
         */
        function updateWithdrawalCalculations() {
            const amountRbx = parseInt(redeemAmountRbxInput.value, 10);
            
            if (isNaN(amountRbx) || amountRbx < MIN_WITHDRAW_RBX) {
                xdDeductedAmountEl.textContent = '0';
                gamepassAmountEl.textContent = '0';
                withdrawBtn.disabled = true;
                return;
            }
        
            const xdToDeduct = amountRbx * RBX_TO_XD_RATE;
            const gamepassAmount = Math.ceil(amountRbx / (1 - GAMEPASS_DEDUCTION_RATE));
        
            xdDeductedAmountEl.textContent = xdToDeduct.toLocaleString();
            gamepassAmountEl.textContent = gamepassAmount.toLocaleString();
        
            if (xdBalance >= xdToDeduct) {
                withdrawBtn.disabled = false;
            } else {
                withdrawBtn.disabled = true;
            }
        }
        
        /**
         * Handles the withdrawal request from the form and awards referral bonus.
         * @param {Event} e The form submission event.
         */
        async function handleWithdraw(e) {
            e.preventDefault();
            const amountRbx = parseInt(redeemAmountRbxInput.value, 10);
            const roboxUsername = robloxUsernameInput.value.trim();
        
            if (isNaN(amountRbx) || amountRbx < MIN_WITHDRAW_RBX) {
                console.error('Withdrawal Failed', `Please enter a valid amount of at least ${MIN_WITHDRAW_RBX} RBX.`);
                return;
            }
        
            if (roboxUsername === '') {
                console.error('Withdrawal Failed', 'Roblox username cannot be empty.');
                return;
            }
        
            const xdToDeduct = amountRbx * RBX_TO_XD_RATE;
            const gamepassAmount = Math.ceil(amountRbx / (1 - GAMEPASS_DEDUCTION_RATE));
        
            if (xdBalance < xdToDeduct) {
                console.error('Withdrawal Failed', `You do not have enough XD to withdraw this amount. You need ${xdToDeduct} XD.`);
                return;
            }
            
            xdBalance -= xdToDeduct;
        
            notifications.unshift({
                message: `Withdrawal request for ${amountRbx} RBX submitted for Roblox user "${roboxUsername}". A total of ${xdToDeduct} XD was deducted.`,
                timestamp: new Date().toISOString()
            });
        
            if (referredBy) {
                const bonusAmount = xdToDeduct * REFERRAL_BONUS_RATE;
                const referrerData = await fetchUserData(referredBy);
                if (referrerData) {
                    const newReferrerBalance = referrerData.xdBalance + bonusAmount;
                    const referrerNotifications = referrerData.notifications || [];
                    referrerNotifications.unshift({
                        message: `Referral bonus! You received ${bonusAmount.toFixed(0)} XD from a withdrawal by a user you referred.`,
                        timestamp: new Date().toISOString()
                    });
                    await updateUserData(referredBy, { xdBalance: newReferrerBalance, notifications: referrerNotifications });
                }
            }
        
            await updateUserData(userId, { xdBalance: xdBalance, notifications: notifications });
        
            withdrawForm.reset();
        
            updateUI();
            
            console.log('Withdrawal Successful', `Your withdrawal request for ${amountRbx} RBX has been submitted. We have deducted ${xdToDeduct} XD from your balance. Please create a Gamepass of ${gamepassAmount} RBX as instructed.`);
        }
        
        /**
         * Clears all notifications from the list.
         */
        async function clearNotifications() {
            notifications = [];
            await updateUserData(userId, { notifications: notifications });
            updateUI();
        }
        
        /**
         * Initializes the main game loop and UI after a successful login.
         */
        async function initializeGame() {
            const userData = await fetchUserData(userId);
            if (userData) {
                xdBalance = userData.xdBalance || 0;
                jackpot = userData.jackpot || 0;
                username = userData.username || 'Guest';
                userReferralCode = userData.userReferralCode || '';
                referredBy = userData.referredBy || null;
                notifications = userData.notifications || [];
            }
            
            setInterval(async () => {
                jackpot += JACKPOT_INCREMENT_PER_MINUTE;
                await updateUserData(userId, { jackpot: jackpot });
                updateUI();
            }, 60 * 1000);
        
            updateUI();
            createLightBulbs(); // Call the new function to create the light bulbs
        
            spinBtn.addEventListener('click', spin);
            withdrawForm.addEventListener('submit', handleWithdraw);
            clearNotificationsBtn.addEventListener('click', clearNotifications);
            redeemAmountRbxInput.addEventListener('input', updateWithdrawalCalculations);
            
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const logoutBtn = document.getElementById('logout-btn');
        
            menuBtn.addEventListener('click', () => {
                sidebar.classList.remove('translate-x-full');
            });
            closeMenuBtn.addEventListener('click', () => {
                sidebar.classList.add('translate-x-full');
            });
        
            const sidebarLinks = document.querySelectorAll('#sidebar a[data-section]');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.target.getAttribute('data-section');
                    spinSection.classList.add('hidden');
                    withdrawSection.classList.add('hidden');
                    notificationSection.classList.add('hidden');
                    document.getElementById('policy-section').classList.add('hidden');
                    document.getElementById(`${sectionId}-section`).classList.remove('hidden');
                    if (sectionId === 'withdraw') {
                        updateWithdrawalCalculations();
                    }
                    sidebar.classList.add('translate-x-full');
                });
            });
        
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
            });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            await authenticateUser();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    initializeGame();
                } else {
                    console.log("Authentication Required", "You must be logged in to play. Please visit the login page.");
                    console.log("User not logged in.");
                }
            });
        });
    </script>
</body>
</html>
